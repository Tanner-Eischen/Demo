# Handoff: Timeline-First TTS + Demo Runner Refactor

Date: 2026-02-19  
Status: Implementation pass completed, handoff ready.

## What Was Completed

1. Timeline-first data model and migration:
- Added timeline domain and validation:
  - `backend/app/timeline/models.py`
  - `backend/app/timeline/validator.py`
  - `backend/app/timeline/parsers_timestamped_txt.py`
  - `backend/app/timeline/parsers_srt.py`
  - `backend/app/timeline/normalizer.py`
  - `backend/app/timeline/importers.py`
  - `backend/app/timeline/errors.py`
- Added timeline schema:
  - `schemas/timeline.schema.json`
- Upgraded project defaults/migration to schema `2.0.0`:
  - `backend/app/storage.py`
  - `schemas/project.schema.json`

2. API expansion:
- Timeline import/get/patch:
  - `POST /projects/{project_id}/timeline/import`
  - `GET /projects/{project_id}/timeline`
  - `PATCH /projects/{project_id}/timeline/narration/{event_id}`
- Render endpoint:
  - `POST /projects/{project_id}/render`
  - `POST /projects/{project_id}/run` remains alias
- TTS profile + preview:
  - `POST /projects/{project_id}/tts/profile`
  - `GET /projects/{project_id}/tts/profile`
  - `POST /projects/{project_id}/tts/preview`
- Demo/action endpoints:
  - `POST /projects/{project_id}/timeline/actions/validate`
  - `POST /projects/{project_id}/demo/run`
  - `GET /projects/{project_id}/demo/runs`
- Dependency health:
  - `GET /health/deps`

3. TTS-first pipeline:
- Default narration mode switched to `tts_only`:
  - `backend/app/config.py`
  - `backend/app/storage.py`
  - `backend/app/pipeline/pipeline_main.py`
- New timeline-driven renderer:
  - `backend/app/pipeline/tts_only.py`
- Added TTS cache/postprocess/profile services:
  - `backend/app/tts/cache.py`
  - `backend/app/tts/postprocess.py`
  - `backend/app/tts/profiles.py`
- Updated TTS call path for endpoint/mode overrides:
  - `backend/app/pipeline/tts.py`

4. Demo runner and unified mode:
- Added demo runner scaffold + validator + jobs:
  - `backend/app/demo_runner/models.py`
  - `backend/app/demo_runner/validator.py`
  - `backend/app/demo_runner/runner.py`
  - `backend/app/demo_runner/jobs.py`
- Added unified orchestrator:
  - `backend/app/pipeline/unified.py`
- `pipeline_main` supports:
  - `tts_only` (default)
  - `unified`
  - `legacy_segment` / `legacy_holistic`

5. Ops/docs updates:
- `scripts/monitor-pipeline.ps1` updated for `tts_only`.
- `scripts/ci_smoke.sh` now includes:
  - health checks
  - sample upload
  - timeline import
  - render enqueue
  - render completion polling
- Added migration notes:
  - `docs/MIGRATION.md`
- Updated:
  - `docs/API.md`
  - `docs/TECHNICAL_DESIGN.md`
  - `docs/PROJECT_SPEC.md`
  - `docs/OPERATIONS.md`
  - `docs/MASTER_TASKLIST.md`

## Verification Performed

- `python -m compileall backend worker`
- `python -m unittest backend.app.timeline.test_importers backend.app.demo_runner.test_validator -v`
- `bash -n scripts/ci_smoke.sh`

## Known Limitations / Follow-up Items

1. Playwright execution is runtime-optional:
- If Playwright import/browser setup is unavailable, demo runner falls back to deterministic dry-run with placeholder artifact behavior.

2. Full e2e Docker smoke was prepared in script but not executed in this handoff step:
- Run `scripts/ci_smoke.sh` to validate environment-specific behavior.

3. Legacy code still exists for compatibility:
- It is deferred-loaded and only used when explicitly selecting legacy modes.

## Recommended Next Thread Scope

1. Runtime hardening pass:
- Run full `scripts/ci_smoke.sh`.
- Run a real project in `tts_only` and one in `unified`.
- Fix environment/runtime issues surfaced by real execution.

2. Playwright productionization pass:
- Ensure Playwright dependency install path is deterministic in CI/local.
- Validate real `raw_demo.mp4` generation (non-empty artifact).

3. Add API-level integration tests for new endpoints.

## Ready-to-Paste Next Thread Prompt

Use this to start the next thread:

```text
Continue from handoff: docs/HANDOFF_2026-02-19.md

Goals for this thread:
1) Run full runtime validation (including scripts/ci_smoke.sh) and fix issues.
2) Validate both narration_mode=tts_only and narration_mode=unified with real artifacts.
3) Add/expand integration tests for new timeline/tts/demo endpoints.
4) Keep docs/MASTER_TASKLIST.md updated with any newly discovered follow-up tasks.

Constraints:
- Do not revert unrelated user changes.
- Keep legacy paths compatibility unless explicitly removing them in a dedicated cleanup PR.
```
